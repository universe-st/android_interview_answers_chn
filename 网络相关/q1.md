# 请你描述TCP三次握手与四次挥手的过程与意义

TCP（传输控制协议）是一种面向连接、可靠的传输层协议，其“连接建立”和“连接终止”过程分别通过**三次握手**和**四次挥手**实现，核心目的是确保通信双方的收发能力正常，并有序传输数据。


### 一、三次握手（连接建立过程）
三次握手用于客户端和服务器建立可靠连接，确保双方都能正常收发数据。过程如下：

#### 1. 第一次握手（客户端 → 服务器）
- **动作**：客户端主动发送一个 `SYN`（同步序列编号）报文，包含客户端的初始序列号（记为 `seq = x`）。
- **状态变化**：客户端发送后进入 `SYN_SENT` 状态，等待服务器回应。
- **意义**：客户端告诉服务器“我想和你建立连接，我的初始序列号是 x，你可以用这个序号来确认我的数据”。


#### 2. 第二次握手（服务器 → 客户端）
- **动作**：服务器收到 `SYN` 报文后，确认客户端的请求，回复一个 `SYN+ACK` 报文。  
  其中：`ACK`（确认标志）的确认号为 `x+1`（表示已收到客户端的 `SYN` 报文）；服务器自己的初始序列号为 `seq = y`。
- **状态变化**：服务器进入 `SYN_RCVD` 状态，等待客户端确认。
- **意义**：服务器告诉客户端“我收到你的连接请求了，我的初始序列号是 y，你可以用这个序号来确认我的数据”。


#### 3. 第三次握手（客户端 → 服务器）
- **动作**：客户端收到 `SYN+ACK` 报文后，发送一个 `ACK` 报文，确认号为 `y+1`（表示已收到服务器的 `SYN` 报文），自身序列号为 `x+1`。
- **状态变化**：客户端发送后进入 `ESTABLISHED`（连接已建立）状态；服务器收到 `ACK` 后也进入 `ESTABLISHED` 状态。
- **意义**：客户端告诉服务器“我收到你的回应了，我们可以开始传输数据了”。


**三次握手的核心意义**：  
通过三次交互，双方确认了彼此的“发送能力”和“接收能力”：  
- 第一次握手：客户端能发，服务器能收；  
- 第二次握手：服务器能发，客户端能收（客户端收到服务器的回应）；  
- 第三次握手：服务器能收客户端的确认（确保客户端确实能接收服务器的数据）。  
避免了因网络延迟导致的“无效连接”（例如旧的连接请求报文突然到达服务器，三次握手可通过序列号验证其有效性）。


### 二、四次挥手（连接终止过程）
TCP 是全双工通信（双方可同时发送数据），四次挥手用于双方有序关闭连接，确保所有数据都被正确接收。过程如下（假设客户端先发起关闭）：

#### 1. 第一次挥手（客户端 → 服务器）
- **动作**：客户端发送 `FIN`（结束标志）报文，序列号为 `seq = u`（客户端当前的序列号），表示“我没有数据要发给你了”。
- **状态变化**：客户端进入 `FIN_WAIT_1` 状态，等待服务器确认。
- **意义**：客户端主动关闭自己的“发送方向”连接。


#### 2. 第二次挥手（服务器 → 客户端）
- **动作**：服务器收到 `FIN` 后，回复 `ACK` 报文，确认号为 `u+1`（表示已收到客户端的关闭请求），自身序列号为 `seq = v`。
- **状态变化**：服务器进入 `CLOSE_WAIT` 状态（此时服务器仍可向客户端发送数据）；客户端收到 `ACK` 后进入 `FIN_WAIT_2` 状态。
- **意义**：服务器告诉客户端“我收到你要关闭的请求了，但我可能还有数据没发完，请等我处理完”。


#### 3. 第三次挥手（服务器 → 客户端）
- **动作**：服务器处理完剩余数据后，发送 `FIN` 报文，序列号为 `seq = w`（服务器当前的序列号），表示“我也没有数据要发了”。
- **状态变化**：服务器进入 `LAST_ACK` 状态，等待客户端确认。
- **意义**：服务器关闭自己的“发送方向”连接。


#### 4. 第四次挥手（客户端 → 服务器）
- **动作**：客户端收到 `FIN` 后，发送 `ACK` 报文，确认号为 `w+1`（表示已收到服务器的关闭请求），自身序列号为 `u+1`。
- **状态变化**：客户端进入 `TIME_WAIT` 状态（等待 2 倍最大报文段寿命 `2MSL`），服务器收到 `ACK` 后进入 `CLOSED` 状态；客户端等待 `TIME_WAIT` 结束后也进入 `CLOSED` 状态。
- **意义**：客户端确认服务器的关闭请求，确保服务器能收到最终确认（避免服务器因未收到 `ACK` 而重发 `FIN`）。


**四次挥手的核心意义**：  
由于 TCP 是全双工通信，双方需独立关闭各自的“发送方向”连接：  
- 前两次挥手：客户端关闭发送方向，服务器确认收到；  
- 后两次挥手：服务器关闭发送方向，客户端确认收到。  
`TIME_WAIT` 状态的作用是：确保网络中残留的旧报文段已消失，避免干扰新连接；同时给服务器足够时间收到最后一个 `ACK`（若丢失，服务器会重发 `FIN`，客户端可再次回应）。


### 总结
- **三次握手**：通过三次交互确认双方收发能力，建立可靠连接，避免无效连接。  
- **四次挥手**：通过四次交互有序关闭全双工连接，确保所有数据被接收，避免数据丢失。