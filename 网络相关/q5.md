# SSL握手的过程都经历过什么？

SSL（Secure Sockets Layer）握手是客户端与服务器之间建立安全连接的核心过程，其目的是**协商加密规则、验证身份、安全交换密钥**，最终为后续通信提供对称加密的会话密钥。目前SSL已被TLS（Transport Layer Security）取代，但“SSL握手”仍是行业习惯说法。


### 以TLS 1.2为例（最经典流程），握手过程主要包括以下步骤：


#### 1. 客户端发起请求（Client Hello）
客户端向服务器发送“问候”消息，包含以下关键信息：
- 支持的TLS版本（如TLS 1.2）；
- 支持的加密套件列表（如`ECDHE-RSA-AES256-GCM-SHA384`，包含密钥交换算法、对称加密算法、哈希算法等）；
- 客户端随机数（`Client Random`，32字节随机值，用于后续生成会话密钥）；
- 会话ID（可选，用于复用已有会话，减少握手开销）。


#### 2. 服务器回应（Server Hello）
服务器收到客户端消息后，回应“问候”消息，确定双方使用的规则：
- 选定的TLS版本（从客户端支持的版本中选择）；
- 选定的加密套件（从客户端列表中选择，如服务器最终选`ECDHE-RSA-AES256-GCM-SHA384`）；
- 服务器随机数（`Server Random`，32字节随机值，与客户端随机数共同参与密钥生成）；
- 会话ID（若复用会话则返回已有ID，否则生成新ID）。


#### 3. 服务器发送证书（Certificate）
服务器向客户端提供**数字证书**（由可信CA签发），用于证明自己的身份。证书包含：
- 服务器域名（确保访问的是目标服务器）；
- 服务器公钥（用于后续加密密钥材料）；
- CA签名（证明证书的有效性）。


#### 4. 服务器密钥交换（Server Key Exchange，可选）
若选定的加密套件使用**Diffie-Hellman（DH）或ECDHE（椭圆曲线DH）** 等密钥交换算法（非对称加密，支持“前向保密”），服务器需额外发送：
- 服务器的DH/ECDHE公钥参数（与客户端的公钥配合，双方可独立计算出相同的“预主密钥”）。

*若使用RSA密钥交换（不支持前向保密），此步骤省略，直接用证书中的公钥加密后续密钥。*


#### 5. 服务器确认问候结束（Server Hello Done）
服务器发送此消息，告知客户端：“我的问候信息已发送完毕，请继续。”


#### 6. 客户端验证证书并生成预主密钥
客户端收到服务器消息后，执行以下操作：
- **验证证书有效性**：检查证书是否由可信CA签发、是否过期、域名是否匹配、是否被吊销等（若验证失败，客户端可能提示“证书错误”并终止连接）；
- **生成预主密钥（Pre-Master Secret）**：客户端生成一个随机的预主密钥（48字节），并根据加密套件规则处理：
  - 若用RSA：用服务器证书中的公钥加密预主密钥，确保只有服务器（持有私钥）能解密；
  - 若用ECDHE：客户端生成自己的ECDHE公钥，与服务器的ECDHE公钥计算出预主密钥（无需传输，更安全）。


#### 7. 客户端发送密钥材料（Client Key Exchange）
客户端将加密后的预主密钥（或自己的ECDHE公钥）发送给服务器。


#### 8. 客户端计算会话密钥并通知切换加密模式
- **生成会话密钥**：客户端用`Client Random`、`Server Random`和`Pre-Master Secret`，通过TLS规定的伪随机函数（PRF）生成**主密钥（Master Secret）**，再由主密钥派生出实际用于通信的对称加密密钥（如AES密钥）、MAC密钥（用于验证消息完整性）等；
- 发送`Change Cipher Spec`：告知服务器“后续消息将使用协商好的加密套件和会话密钥加密”；
- 发送`Finished`消息：用会话密钥加密一段验证数据（基于握手过程的所有消息），证明客户端已正确生成会话密钥。


#### 9. 服务器计算会话密钥并确认
- 服务器用私钥解密（RSA模式）或通过ECDHE参数计算（ECDHE模式）得到预主密钥；
- 用与客户端相同的算法（`Client Random`+`Server Random`+`Pre-Master Secret`）生成相同的会话密钥；
- 发送`Change Cipher Spec`：告知客户端“后续消息将加密”；
- 发送`Finished`消息：用会话密钥加密验证数据，证明服务器已正确生成会话密钥。


#### 10. 握手完成，开始加密通信
客户端和服务器分别验证对方的`Finished`消息：
- 若验证通过，说明双方生成的会话密钥一致，且握手过程未被篡改；
- 后续所有通信（如HTTP数据）均使用协商好的对称加密算法（如AES）和会话密钥进行加密，确保机密性和完整性。


### TLS 1.3的简化（更高效）
TLS 1.3大幅简化了握手流程，减少了网络往返次数（从TLS 1.2的2-3次往返减少到1次）：
- 客户端在`Client Hello`中就携带密钥交换材料（如ECDHE公钥）；
- 服务器回应时直接包含证书、`Finished`消息等，无需单独的`Server Hello Done`；
- 移除了不安全的加密套件（如RSA密钥交换），强制使用支持前向保密的算法（如ECDHE）。


### 核心目的总结
SSL/TLS握手通过“身份验证（证书）、密钥协商（随机数+预主密钥）、加密验证（Finished消息）”三个核心环节，确保客户端与服务器能安全地使用对称加密进行后续通信，防止窃听、篡改和伪装攻击。