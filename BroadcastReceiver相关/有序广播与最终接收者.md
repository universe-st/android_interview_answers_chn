# 有序广播的优先级如何设置？最终接收者（Final Receiver）的作用是什么？

在有序广播（Ordered Broadcast）中，优先级决定了接收器接收广播的顺序，而最终接收者（Final Receiver）则用于确保广播事件的最终处理，即使广播被中途拦截。以下是详细说明：


### 一、有序广播的优先级设置  
有序广播的优先级通过`intent-filter`指定，决定了接收器的接收顺序（优先级越高，越先接收）。优先级的设置方式分两种：  


#### 1. 静态注册时设置（AndroidManifest.xml）  
在`<receiver>`的`<intent-filter>`标签中，通过`android:priority`属性设置优先级，取值范围为 **-1000~1000**，值越大优先级越高。  

```xml
<!-- 高优先级接收器（优先级100） -->
<receiver android:name=".HighPriorityReceiver">
    <intent-filter android:priority="100"> <!-- 优先级设置 -->
        <action android:name="com.example.ORDERED_ACTION" />
    </intent-filter>
</receiver>

<!-- 低优先级接收器（优先级50） -->
<receiver android:name=".LowPriorityReceiver">
    <intent-filter android:priority="50"> <!-- 优先级更低 -->
        <action android:name="com.example.ORDERED_ACTION" />
    </intent-filter>
</receiver>
```  


#### 2. 动态注册时设置（代码中）  
通过`IntentFilter`对象的`setPriority(int)`方法设置优先级，同样遵循 **-1000~1000** 的范围。  

```java
// 动态注册高优先级接收器
IntentFilter highFilter = new IntentFilter("com.example.ORDERED_ACTION");
highFilter.setPriority(100); // 设置优先级为100
registerReceiver(highReceiver, highFilter);

// 动态注册低优先级接收器
IntentFilter lowFilter = new IntentFilter("com.example.ORDERED_ACTION");
lowFilter.setPriority(50); // 设置优先级为50
registerReceiver(lowReceiver, lowFilter);
```  


**优先级规则补充**：  
- 若多个接收器优先级相同，静态注册的接收器可能比动态注册的先接收（具体顺序由系统调度决定）。  
- 优先级仅在有序广播中有效，无序广播（普通广播）会忽略优先级设置。  


### 二、最终接收者（Final Receiver）的作用  
最终接收者是在发送有序广播时，通过`sendOrderedBroadcast()`方法指定的一个特殊`BroadcastReceiver`，其核心作用是：**无论广播是否被中途拦截，都会收到最终通知**，用于获取广播的最终处理结果或执行收尾逻辑。  


#### 1. 最终接收者的特点  
- **不受拦截影响**：即使高优先级的接收器调用`abortBroadcast()`拦截了广播，最终接收者仍会被触发。  
- **最后接收**：在所有普通接收器（无论是否处理或拦截）之后执行，确保获取的是最终状态。  
- **独立于优先级**：无需设置优先级，也无需在Manifest中注册，仅在发送广播时通过参数指定。  


#### 2. 使用示例  
发送有序广播时，通过`sendOrderedBroadcast()`的第三个参数指定最终接收者：  

```java
// 1. 定义最终接收者
BroadcastReceiver finalReceiver = new BroadcastReceiver() {
    @Override
    public void onReceive(Context context, Intent intent) {
        // 无论广播是否被拦截，都会执行
        String resultData = getResultData(); // 获取最终数据（可能被修改过）
        int resultCode = getResultCode(); // 获取最终结果码
        Toast.makeText(context, "最终结果：" + resultData, Toast.LENGTH_SHORT).show();
    }
};

// 2. 发送有序广播，并指定最终接收者
Intent intent = new Intent("com.example.ORDERED_ACTION");
sendOrderedBroadcast(
    intent,
    null, // 接收权限（可选）
    finalReceiver, // 最终接收者
    null, // 处理结果的Handler（null表示主线程）
    Activity.RESULT_OK, // 初始结果码
    "初始数据", // 初始数据
    null // 额外数据
);
```  


#### 3. 典型应用场景  
- **结果汇总**：收集多个接收器对广播的处理结果（如多个插件对同一事件的处理反馈）。  
- **安全兜底**：确保广播事件有最终的记录或处理，防止关键逻辑因广播被拦截而丢失（如日志记录、统计上报）。  


### 总结  
- 有序广播的优先级通过`android:priority`（静态）或`setPriority()`（动态）设置，决定接收顺序（-1000~1000，值越大越先接收）。  
- 最终接收者是一个特殊接收器，无论广播是否被拦截都会触发，用于获取最终结果或执行兜底逻辑，确保事件处理的完整性。