# 发送广播时如何设置权限，确保只有具备相应权限的应用才能接收？

在Android中，发送广播时可通过**指定接收权限**的方式，确保只有声明了对应权限的应用才能接收该广播。核心逻辑是：发送方在广播时绑定一个权限，接收方必须在清单文件中声明该权限，否则无法接收。具体实现步骤如下：


### 一、声明自定义权限（发送方）
首先需要在发送方应用的`AndroidManifest.xml`中声明一个自定义权限（若使用系统已有的权限，可跳过此步），明确权限的保护级别，限制谁能申请该权限。

```xml
<!-- 在发送方的AndroidManifest.xml中声明权限 -->
<permission
    android:name="com.example.permission.RECEIVE_MY_BROADCAST"  <!-- 权限名称（建议用包名前缀） -->
    android:protectionLevel="signature"  <!-- 保护级别：控制谁能申请该权限 -->
    android:label="接收我的广播的权限"
    android:description="只有声明了该权限的应用才能接收我的广播"/>
```

**关键属性说明**：  
- `android:protectionLevel`：决定哪些应用可以申请该权限，直接影响安全性：  
  - `signature`：**最安全**，只有与发送方应用使用**相同签名**的应用才能申请该权限（适合同一开发者的关联应用）。  
  - `dangerous`：需要用户手动授权（在Android 6.0+中需动态申请），适合向非信任应用开放但需用户确认的场景。  
  - `normal`：任何应用都可申请，无需用户授权（安全性低，不推荐用于敏感广播）。  


### 二、发送广播时绑定权限（发送方）
发送广播时，通过`sendBroadcast(Intent, String)`方法的第二个参数，指定“接收者必须声明的权限”。未声明该权限的应用，即使注册了匹配的`action`，也无法接收此广播。

**代码示例**：  
```java
// 创建广播Intent
Intent intent = new Intent("com.example.MY_BROADCAST_ACTION");
intent.putExtra("data", "需要传递的内容");

// 发送广播，并指定接收者必须拥有"com.example.permission.RECEIVE_MY_BROADCAST"权限
// 第二个参数为权限名称：只有声明了该权限的应用才能接收
sendBroadcast(intent, "com.example.permission.RECEIVE_MY_BROADCAST");
```

- 若发送的是**有序广播**，同理可通过`sendOrderedBroadcast(Intent, String, ...)`的第二个参数指定接收权限。  
- 若使用系统已有的权限（如`android.permission.INTERNET`），可直接将权限名作为第二个参数，无需自定义。  


### 三、接收方声明权限（接收方）
接收方应用必须在自己的`AndroidManifest.xml`中声明发送方指定的权限，才能正常接收广播。

```xml
<!-- 在接收方的AndroidManifest.xml中声明权限 -->
<uses-permission android:name="com.example.permission.RECEIVE_MY_BROADCAST" />

<!-- 注册接收器（静态注册示例） -->
<receiver android:name=".MyReceiver">
    <intent-filter>
        <action android:name="com.example.MY_BROADCAST_ACTION" />
    </intent-filter>
</receiver>
```

- 若接收方未声明该权限，即使`intent-filter`匹配`action`，也会被系统过滤，无法触发`onReceive()`。  
- 若权限的`protectionLevel`为`signature`，接收方还需与发送方使用**相同的签名文件**签名，否则权限申请无效。  


### 四、完整流程示例
#### 1. 发送方配置
- **AndroidManifest.xml**（声明权限）：  
  ```xml
  <permission
      android:name="com.example.permission.SECURE_BROADCAST"
      android:protectionLevel="signature"/>
  
  <application ...>
      <!-- 发送方组件（如Activity） -->
      <activity android:name=".SenderActivity"/>
  </application>
  ```

- **发送广播的代码**（SenderActivity）：  
  ```java
  public class SenderActivity extends AppCompatActivity {
      public void sendSecureBroadcast(View view) {
          Intent intent = new Intent("com.example.SECURE_ACTION");
          intent.putExtra("secret", "敏感数据");
          // 绑定权限：只有声明了该权限的应用可接收
          sendBroadcast(intent, "com.example.permission.SECURE_BROADCAST");
      }
  }
  ```


#### 2. 接收方配置
- **AndroidManifest.xml**（声明权限+注册接收器）：  
  ```xml
  <!-- 声明需要的权限 -->
  <uses-permission android:name="com.example.permission.SECURE_BROADCAST" />
  
  <application ...>
      <receiver android:name=".SecureReceiver">
          <intent-filter>
              <action android:name="com.example.SECURE_ACTION" />
          </intent-filter>
      </receiver>
  </application>
  ```

- **接收广播的代码**（SecureReceiver）：  
  ```java
  public class SecureReceiver extends BroadcastReceiver {
      @Override
      public void onReceive(Context context, Intent intent) {
          if ("com.example.SECURE_ACTION".equals(intent.getAction())) {
              String secret = intent.getStringExtra("secret");
              // 处理接收到的敏感数据
          }
      }
  }
  ```

- **签名要求**：接收方需与发送方使用相同的签名文件（因权限保护级别为`signature`），否则无法接收。  


### 五、注意事项
1. **权限名称唯一性**：自定义权限名称需唯一（建议用包名前缀），避免与其他应用的权限冲突。  
2. **动态权限适配**：若权限为`dangerous`级别（如涉及用户隐私），Android 6.0+ 需在代码中动态申请（`Activity.requestPermissions()`），否则接收方即使在Manifest中声明也无效。  
3. **显式广播配合**：若需进一步限制接收范围，可结合**显式广播**（`intent.setComponent()`指定接收组件），双重保障安全性。  
4. **系统权限慎用**：尽量使用自定义权限，避免滥用系统权限（系统权限可能有更严格的申请条件）。  


通过上述步骤，发送方可以精确控制“哪些应用能接收广播”，有效防止恶意应用监听敏感信息，提升广播通信的安全性。